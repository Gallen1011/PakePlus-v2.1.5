<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>辅导员谈心谈话管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }
        
        /* 登录页面样式 */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, rgba(33, 105, 235, 0.9) 0%, rgba(33, 105, 235, 0.7) 100%);
        }
        
        .login-box {
            background-color: white;
            border-radius: 12px;
            padding: 40px;
            width: 420px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h2 {
            color: #2169eb;
            font-size: 26px;
            margin-bottom: 10px;
        }
        
        .login-header p {
            color: #666;
            font-size: 14px;
        }
        
        .login-form .form-group {
            margin-bottom: 20px;
        }
        
        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
        }
        
        .login-form input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .login-form input:focus {
            border-color: #2169eb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(33, 105, 235, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background-color: #2169eb;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            background-color: #1a5cd8;
        }
        
        .login-links {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        
        .login-link {
            color: #2169eb;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .login-link:hover {
            text-decoration: underline;
        }
        
        .error-message {
            color: #f44336;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        
        /* 主系统页面 */
        .main-container {
            display: flex;
            height: 100vh;
        }
        
        /* 侧边栏样式 */
        .sidebar {
            width: 240px;
            background: linear-gradient(180deg, #2169eb, #1a5cd8);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .logo {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo h2 {
            font-size: 22px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .logo p {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .menu {
            flex: 1;
            padding: 20px 0;
        }
        
        .menu-item {
            padding: 14px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        
        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.15);
            border-left: 4px solid #4fc3f7;
        }
        
        .menu-item i {
            margin-right: 12px;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        .menu-item span {
            font-size: 15px;
            font-weight: 500;
        }
        
        .user-info {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background-color: #4fc3f7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
        }
        
        .user-details h4 {
            font-size: 15px;
            margin-bottom: 4px;
        }
        
        .user-details p {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* 主内容区样式 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .top-bar {
            height: 70px;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }
        
        .page-title {
            font-size: 22px;
            font-weight: 600;
            color: #333;
        }
        
        .logout-btn {
            background-color: #f5f5f5;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            color: #666;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .logout-btn i {
            margin-right: 6px;
        }
        
        .content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }
        
        /* 工作台样式 */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
            cursor: pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .stat-card:nth-child(1) .stat-icon {
            background-color: #e3f2fd;
            color: #2169eb;
        }
        
        .stat-card:nth-child(2) .stat-icon {
            background-color: #e8f5e9;
            color: #388e3c;
        }
        
        .stat-card:nth-child(3) .stat-icon {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .stat-card:nth-child(4) .stat-icon {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .recent-records {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            height: calc(100% - 140px);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            color: #2169eb;
        }
        
        /* 表单样式 */
        .form-container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            height: 100%;
            overflow-y: auto;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #2169eb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(33, 105, 235, 0.1);
        }
        
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .form-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2169eb;
            display: flex;
            align-items: center;
        }
        
        .form-section-title i {
            margin-right: 10px;
        }
        
        .status-toggle {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .toggle-option {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-radius: 6px;
            background-color: #f5f5f5;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #ddd;
        }
        
        .toggle-option.active {
            background-color: #e8f5e9;
            color: #388e3c;
            font-weight: 500;
            border-color: #388e3c;
        }
        
        .toggle-option.unresolved.active {
            background-color: #ffebee;
            color: #d32f2f;
            border-color: #d32f2f;
        }
        
        .toggle-option i {
            margin-right: 8px;
        }
        
        .form-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-primary {
            background-color: #2169eb;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1a5cd8;
        }
        
        .btn-secondary {
            background-color: #f5f5f5;
            color: #666;
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        /* 记录列表样式 */
        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .search-box {
            position: relative;
            width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .records-list {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            height: calc(100% - 80px);
            overflow-y: auto;
        }
        
        .record-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
            position: relative;
        }
        
        .record-item:hover {
            background-color: #f9f9f9;
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .student-info {
            flex: 1;
        }
        
        .student-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .student-id {
            font-size: 14px;
            color: #666;
        }
        
        .talk-time {
            font-size: 14px;
            color: #999;
            white-space: nowrap;
        }
        
        .record-tags {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .tag {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .tag-type {
            background-color: #e3f2fd;
            color: #2169eb;
        }
        
        .tag-class {
            background-color: #f5f5f5;
            color: #666;
        }
        
        .tag-risk-low {
            background-color: #e8f5e9;
            color: #388e3c;
        }
        
        .tag-risk-medium {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .tag-risk-high {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .talk-purpose {
            font-size: 14px;
            color: #555;
            margin-bottom: 15px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .record-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .action-btn {
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s;
            border: none;
        }
        
        .action-btn i {
            margin-right: 5px;
        }
        
        .view-btn {
            background-color: #e8f5e9;
            color: #388e3c;
        }
        
        .view-btn:hover {
            background-color: #c8e6c9;
        }
        
        .edit-btn {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .edit-btn:hover {
            background-color: #ffe0b2;
        }
        
        .delete-btn {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .delete-btn:hover {
            background-color: #ffcdd2;
        }
        
        .no-records {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }
        
        .no-records i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #e0e0e0;
        }
        
        /* 数据管理样式 */
        .data-management {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            height: 100%;
            overflow-y: auto;
        }
        
        .data-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .data-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .data-section-title i {
            margin-right: 10px;
            color: #2169eb;
        }
        
        .data-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .data-btn {
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s;
            border: none;
        }
        
        .data-btn i {
            margin-right: 8px;
        }
        
        .export-btn {
            background-color: #e8f5e9;
            color: #388e3c;
        }
        
        .export-btn:hover {
            background-color: #c8e6c9;
        }
        
        .import-btn {
            background-color: #e3f2fd;
            color: #2169eb;
        }
        
        .import-btn:hover {
            background-color: #bbdefb;
        }
        
        .clear-btn {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .clear-btn:hover {
            background-color: #ffcdd2;
        }
        
        .template-note {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .template-note h4 {
            margin-bottom: 8px;
            color: #333;
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
            }
            
            .logo h2, .logo p, .menu-item span, .user-details {
                display: none;
            }
            
            .menu-item {
                justify-content: center;
                padding: 18px 0;
            }
            
            .menu-item i {
                margin-right: 0;
                font-size: 20px;
            }
            
            .user-info {
                justify-content: center;
            }
            
            .user-avatar {
                margin-right: 0;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .form-row-2 {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .records-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-box {
                width: 100%;
                margin-top: 15px;
            }
            
            .record-actions {
                margin-top: 15px;
                width: 100%;
                justify-content: flex-end;
            }
        }
        
        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        /* 风险等级颜色定义 */
        .risk-low {
            color: #388e3c;
        }
        
        .risk-medium {
            color: #f57c00;
        }
        
        .risk-high {
            color: #d32f2f;
        }
        
        /* 页面内容区域 */
        .page-content {
            height: 100%;
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* 隐藏元素 */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 登录页面 -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h2>辅导员谈心谈话系统</h2>
                <p>请使用您的账号密码登录</p>
            </div>
            <div class="login-form">
                <div class="form-group">
                    <label for="loginUsername">账号</label>
                    <input type="text" id="loginUsername" placeholder="请输入账号">
                </div>
                <div class="form-group">
                    <label for="loginPassword">密码</label>
                    <input type="password" id="loginPassword" placeholder="请输入密码">
                </div>
                <button class="login-btn" onclick="login()">登录</button>
                <div class="login-links">
                    <a href="javascript:void(0);" class="login-link" onclick="showRegisterModal()">注册账号</a>
                </div>
                <div id="loginError" class="error-message">账号或密码错误！</div>
            </div>
        </div>
    </div>
    
    <!-- 主系统页面 -->
    <div id="mainPage" class="main-container hidden">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="logo">
                <h2>谈心谈话系统</h2>
                <p>辅导员工作平台</p>
            </div>
            <div class="menu">
                <div class="menu-item active" data-page="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>工作台</span>
                </div>
                <div class="menu-item" data-page="newRecord">
                    <i class="fas fa-plus-circle"></i>
                    <span>新建谈话记录</span>
                </div>
                <div class="menu-item" data-page="allRecords">
                    <i class="fas fa-list-ul"></i>
                    <span>所有谈话记录</span>
                </div>
                <div class="menu-item" data-page="dataManagement">
                    <i class="fas fa-database"></i>
                    <span>数据管理</span>
                </div>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">辅</div>
                <div class="user-details">
                    <h4 id="userDisplayName">辅导员</h4>
                    <p>用户ID: <span id="userIdDisplay">5042</span></p>
                </div>
            </div>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
            <div class="top-bar">
                <div class="page-title" id="pageTitle">工作台</div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> 退出登录
                </button>
            </div>
            
            <div class="content">
                <!-- 工作台页面 -->
                <div id="dashboardPage" class="page-content active">
                    <div class="dashboard-stats">
                        <div class="stat-card" onclick="showRecordsByType('all')">
                            <div class="stat-icon">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div class="stat-value" id="totalStudents">0</div>
                            <div class="stat-label">已记录学生数</div>
                        </div>
                        <div class="stat-card" onclick="showRecordsByType('all')">
                            <div class="stat-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="stat-value" id="totalTalks">0</div>
                            <div class="stat-label">谈心谈话总数</div>
                        </div>
                        <div class="stat-card" onclick="showRecordsByType('thisMonth')">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="stat-value" id="monthTalks">0</div>
                            <div class="stat-label">本月记录数</div>
                        </div>
                        <div class="stat-card" onclick="showRecordsByType('pending')">
                            <div class="stat-icon">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div class="stat-value" id="pendingTalks">0</div>
                            <div class="stat-label">待跟进记录</div>
                        </div>
                    </div>
                    
                    <div class="recent-records">
                        <div class="section-title">
                            <i class="fas fa-history"></i> 最近谈话记录
                        </div>
                        <div id="recentRecordsList">
                            <div class="no-records">
                                <i class="fas fa-comment-slash"></i>
                                <p>暂无谈话记录</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 新建记录页面 -->
                <div id="newRecordPage" class="page-content">
                    <div class="form-container">
                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="fas fa-user-graduate"></i> 学生基本信息
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="studentName">姓名 *</label>
                                    <input type="text" id="studentName" placeholder="请输入学生姓名">
                                </div>
                                <div class="form-group">
                                    <label for="studentId">学号 *</label>
                                    <input type="text" id="studentId" placeholder="请输入学生学号">
                                </div>
                                <div class="form-group">
                                    <label for="studentClass">班级 *</label>
                                    <input type="text" id="studentClass" placeholder="例如：2024级生物科学1班">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="politicalStatus">政治面貌</label>
                                    <select id="politicalStatus">
                                        <option value="">请选择</option>
                                        <option value="中共党员">中共党员</option>
                                        <option value="中共预备党员">中共预备党员</option>
                                        <option value="共青团员">共青团员</option>
                                        <option value="群众">群众</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="previousPosition">曾任职务</label>
                                    <input type="text" id="previousPosition" placeholder="例如：班长、团支书">
                                </div>
                                <div class="form-group">
                                    <label for="currentPosition">现任职务</label>
                                    <input type="text" id="currentPosition" placeholder="例如：学习委员、学生会干事">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="fas fa-comment-dots"></i> 谈话信息
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="talkType">谈话类型 *</label>
                                    <select id="talkType">
                                        <option value="常规关怀">常规关怀</option>
                                        <option value="学业问题">学业问题</option>
                                        <option value="心理困扰">心理困扰</option>
                                        <option value="人际矛盾">人际矛盾</option>
                                        <option value="职业规划">职业规划</option>
                                        <option value="违纪沟通">违纪沟通</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="talkDate">谈话日期 *</label>
                                    <input type="date" id="talkDate">
                                </div>
                                <div class="form-group">
                                    <label for="talkLocation">谈话地点</label>
                                    <input type="text" id="talkLocation" placeholder="如：至善楼208">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="talkPurpose">谈话背景与目的</label>
                                <textarea id="talkPurpose" placeholder="简要描述谈话原因和目的..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="talkContent">谈话主要内容</label>
                                <textarea id="talkContent" placeholder="记录谈话核心内容..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="talkAssessment">关键发现与评估</label>
                                <textarea id="talkAssessment" placeholder="记录关键发现和评估..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="followUpPlan">后续跟进计划</label>
                                <textarea id="followUpPlan" placeholder="记录后续跟进计划..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="reflection">辅导员反思</label>
                                <textarea id="reflection" placeholder="记录本次谈话的反思..."></textarea>
                            </div>
                            
                            <div class="form-row-2">
                                <div class="form-group">
                                    <label for="riskLevel">风险等级</label>
                                    <select id="riskLevel">
                                        <option value="低">低</option>
                                        <option value="中">中</option>
                                        <option value="高">高</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>解决状态</label>
                                    <div class="status-toggle">
                                        <div class="toggle-option active" data-status="resolved">
                                            <i class="fas fa-check-circle"></i> 已解决
                                        </div>
                                        <div class="toggle-option" data-status="unresolved">
                                            <i class="fas fa-exclamation-circle"></i> 未解决
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-buttons">
                            <button class="btn btn-primary" onclick="saveRecord()">
                                <i class="fas fa-save"></i> 保存记录
                            </button>
                            <button class="btn btn-secondary" onclick="clearForm()">
                                <i class="fas fa-redo"></i> 清空表单
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 所有记录页面 -->
                <div id="allRecordsPage" class="page-content">
                    <div class="records-header">
                        <div class="section-title">
                            <i class="fas fa-list-ul"></i> 所有谈心谈话记录
                        </div>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="搜索学生姓名、学号或谈话内容...">
                        </div>
                    </div>
                    
                    <div class="records-list" id="allRecordsList">
                        <div class="no-records">
                            <i class="fas fa-comment-slash"></i>
                            <p>暂无谈话记录</p>
                        </div>
                    </div>
                </div>
                
                <!-- 数据管理页面 -->
                <div id="dataManagementPage" class="page-content">
                    <div class="data-management">
                        <div class="data-section">
                            <div class="data-section-title">
                                <i class="fas fa-download"></i> 数据导出
                            </div>
                            <p style="margin-bottom: 15px; color: #666;">将系统中的谈心谈话记录导出为Excel文件</p>
                            <div class="data-actions">
                                <button class="data-btn export-btn" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i> 导出为Excel
                                </button>
                            </div>
                        </div>
                        
                        <div class="data-section">
                            <div class="data-section-title">
                                <i class="fas fa-upload"></i> 数据导入
                            </div>
                            <p style="margin-bottom: 15px; color: #666;">从Excel文件批量导入谈心谈话记录</p>
                            <div class="data-actions">
                                <button class="data-btn import-btn" onclick="exportTemplate()">
                                    <i class="fas fa-file-download"></i> 下载导入模板
                                </button>
                                <button class="data-btn import-btn" onclick="document.getElementById('importFile').click()">
                                    <i class="fas fa-file-upload"></i> 从Excel导入
                                </button>
                                <input type="file" id="importFile" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel(this)">
                            </div>
                            <div class="template-note">
                                <h4>导入说明：</h4>
                                <p>1. 请先下载导入模板，按照模板格式填写数据</p>
                                <p>2. 导入操作将添加新记录，不会覆盖现有记录</p>
                                <p>3. 支持导入的字段：姓名、学号、班级、政治面貌、曾任职务、现任职务、谈话类型、谈话日期、谈话地点、风险等级、解决状态、谈话目的、谈话内容、关键发现、跟进计划、反思</p>
                            </div>
                        </div>
                        
                        <div class="data-section">
                            <div class="data-section-title">
                                <i class="fas fa-trash-alt"></i> 数据清理
                            </div>
                            <p style="margin-bottom: 15px; color: #666;">谨慎操作，删除的数据将无法恢复</p>
                            <div class="data-actions">
                                <button class="data-btn clear-btn" onclick="showClearDataModal()">
                                    <i class="fas fa-trash"></i> 清空所有数据
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 注册账号弹窗 -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">注册新账号</div>
                <button class="modal-close" onclick="closeModal('registerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newUsername">新账号</label>
                    <input type="text" id="newUsername" placeholder="请输入新账号">
                </div>
                <div class="form-group">
                    <label for="newPassword">新密码</label>
                    <input type="password" id="newPassword" placeholder="请输入新密码">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">确认密码</label>
                    <input type="password" id="confirmPassword" placeholder="请再次输入密码">
                </div>
                <div id="registerError" class="error-message" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="registerAccount()">注册</button>
                <button class="btn btn-secondary" onclick="closeModal('registerModal')">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 查看记录详情弹窗 -->
    <div id="viewRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">谈话记录详情</div>
                <button class="modal-close" onclick="closeModal('viewRecordModal')">&times;</button>
            </div>
            <div class="modal-body" id="viewRecordContent">
                <!-- 内容将通过JavaScript动态填充 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('viewRecordModal')">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑记录弹窗 -->
    <div id="editRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">编辑谈话记录</div>
                <button class="modal-close" onclick="closeModal('editRecordModal')">&times;</button>
            </div>
            <div class="modal-body" id="editRecordContent">
                <!-- 编辑表单将通过JavaScript动态填充 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveEditedRecord()">保存更改</button>
                <button class="btn btn-secondary" onclick="closeModal('editRecordModal')">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 清空数据确认弹窗 -->
    <div id="clearDataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">清空所有数据</div>
                <button class="modal-close" onclick="closeModal('clearDataModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #d32f2f; margin-bottom: 20px;"><strong>警告：</strong>此操作将删除所有谈心谈话记录，此操作不可恢复！</p>
                <p style="margin-bottom: 15px;">请输入登录密码以确认清空所有数据：</p>
                <div class="form-group">
                    <input type="password" id="clearDataPassword" placeholder="请输入登录密码">
                </div>
                <div id="clearDataError" class="error-message" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="confirmClearData()">确认清空</button>
                <button class="btn btn-secondary" onclick="closeModal('clearDataModal')">取消</button>
            </div>
        </div>
    </div>

    <script>
        // 系统配置
        const CONFIG = {
            defaultUsername: "5042",
            defaultPassword: "1011",
            userStorageKey: "counselorUsers",
            // 修改存储键，为每个用户创建独立的数据存储
            getStorageKey: function(username) {
                return `counselorTalkRecords_${username}`;
            }
        };
        
        // 全局变量
        let talkRecords = [];
        let currentEditingId = null;
        let isResolved = true; // 默认已解决
        let currentUser = null;
        
        // 页面加载初始化
        window.onload = function() {
            // 初始化用户存储
            initializeUserStorage();
            
            // 检查登录状态
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const savedUser = localStorage.getItem('currentUser');
            
            if (isLoggedIn && savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainPage();
            } else {
                showLoginPage();
            }
            
            // 设置默认日期为今天
            document.getElementById('talkDate').valueAsDate = new Date();
            
            // 加载存储的数据
            loadRecords();
            
            // 绑定搜索事件
            document.getElementById('searchInput').addEventListener('input', searchRecords);
            
            // 绑定解决状态切换
            const statusOptions = document.querySelectorAll('.toggle-option');
            statusOptions.forEach(option => {
                option.addEventListener('click', function() {
                    statusOptions.forEach(opt => {
                        opt.classList.remove('active');
                        opt.classList.remove('unresolved');
                    });
                    this.classList.add('active');
                    if (this.dataset.status === 'unresolved') {
                        this.classList.add('unresolved');
                    }
                    isResolved = this.dataset.status === 'resolved';
                });
            });
            
            // 绑定菜单点击事件
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.dataset.page;
                    switchPage(page);
                    
                    // 更新活动菜单项
                    menuItems.forEach(mi => mi.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 更新页面标题
                    updatePageTitle(page);
                });
            });
        };
        
        // 初始化用户存储
        function initializeUserStorage() {
            const users = localStorage.getItem(CONFIG.userStorageKey);
            if (!users) {
                // 创建默认用户
                const defaultUsers = [
                    { username: CONFIG.defaultUsername, password: CONFIG.defaultPassword }
                ];
                localStorage.setItem(CONFIG.userStorageKey, JSON.stringify(defaultUsers));
                
                // 为新用户创建独立的数据存储空间
                const defaultStorageKey = CONFIG.getStorageKey(CONFIG.defaultUsername);
                if (!localStorage.getItem(defaultStorageKey)) {
                    localStorage.setItem(defaultStorageKey, JSON.stringify([]));
                }
            }
        }
        
        // 获取所有用户
        function getUsers() {
            const users = localStorage.getItem(CONFIG.userStorageKey);
            return users ? JSON.parse(users) : [];
        }
        
        // 保存用户
        function saveUsers(users) {
            localStorage.setItem(CONFIG.userStorageKey, JSON.stringify(users));
        }
        
        // 登录功能
        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const users = getUsers();
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = { username: user.username };
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainPage();
                document.getElementById('loginError').style.display = 'none';
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }
        
        // 退出登录
        function logout() {
            localStorage.setItem('isLoggedIn', 'false');
            currentUser = null;
            localStorage.removeItem('currentUser');
            showLoginPage();
        }
        
        // 显示登录页面
        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainPage').classList.add('hidden');
            // 清空登录表单
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
        }
        
        // 显示主页面
        function showMainPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            // 更新用户ID显示
            document.getElementById('userIdDisplay').textContent = currentUser.username;
            // 更新用户头像显示
            document.getElementById('userAvatar').textContent = currentUser.username.charAt(0);
            document.getElementById('userDisplayName').textContent = `辅导员(${currentUser.username})`;
            // 默认显示工作台
            switchPage('dashboard');
            // 加载当前用户的数据
            loadRecords();
        }
        
        // 显示注册弹窗
        function showRegisterModal() {
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('registerError').style.display = 'none';
            openModal('registerModal');
        }
        
        // 注册账号
        function registerAccount() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            const errorElement = document.getElementById('registerError');
            
            // 验证输入
            if (!username || !password || !confirmPassword) {
                errorElement.textContent = '请填写所有字段！';
                errorElement.style.display = 'block';
                return;
            }
            
            if (password !== confirmPassword) {
                errorElement.textContent = '两次输入的密码不一致！';
                errorElement.style.display = 'block';
                return;
            }
            
            if (password.length < 4) {
                errorElement.textContent = '密码长度不能少于4位！';
                errorElement.style.display = 'block';
                return;
            }
            
            const users = getUsers();
            
            // 检查用户名是否已存在
            if (users.some(u => u.username === username)) {
                errorElement.textContent = '该用户名已存在！';
                errorElement.style.display = 'block';
                return;
            }
            
            // 添加新用户
            users.push({ username, password });
            saveUsers(users);
            
            // 为新用户创建独立的数据存储空间
            const newUserStorageKey = CONFIG.getStorageKey(username);
            if (!localStorage.getItem(newUserStorageKey)) {
                localStorage.setItem(newUserStorageKey, JSON.stringify([]));
            }
            
            alert('账号注册成功！');
            closeModal('registerModal');
            
            // 自动填充登录表单
            document.getElementById('loginUsername').value = username;
            document.getElementById('loginPassword').value = password;
        }
        
        // 切换页面
        function switchPage(page) {
            // 隐藏所有页面
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(p => p.classList.remove('active'));
            
            // 显示目标页面
            document.getElementById(page + 'Page').classList.add('active');
            
            // 如果是记录页面，刷新记录列表
            if (page === 'allRecords' || page === 'dashboard') {
                displayAllRecords();
                updateDashboardStats();
            }
        }
        
        // 更新页面标题
        function updatePageTitle(page) {
            const titles = {
                'dashboard': '工作台',
                'newRecord': '新建谈话记录',
                'allRecords': '所有谈话记录',
                'dataManagement': '数据管理'
            };
            document.getElementById('pageTitle').textContent = titles[page];
        }
        
        // 从本地存储加载记录（仅加载当前用户的记录）
        function loadRecords() {
            if (!currentUser) {
                talkRecords = [];
                return;
            }
            
            // 使用用户特定的存储键
            const storageKey = CONFIG.getStorageKey(currentUser.username);
            const stored = localStorage.getItem(storageKey);
            
            if (stored) {
                talkRecords = JSON.parse(stored);
            } else {
                talkRecords = [];
                // 为新用户初始化空数组
                localStorage.setItem(storageKey, JSON.stringify([]));
            }
            updateDashboardStats();
        }
        
        // 保存记录到本地存储（仅保存当前用户的记录）
        function saveRecords() {
            if (!currentUser) return;
            
            // 使用用户特定的存储键
            const storageKey = CONFIG.getStorageKey(currentUser.username);
            localStorage.setItem(storageKey, JSON.stringify(talkRecords));
            updateDashboardStats();
        }
        
        // 保存新记录
        function saveRecord() {
            if (!currentUser) {
                alert('请先登录！');
                return;
            }
            
            // 获取表单数据
            const record = {
                id: Date.now(), // 使用时间戳作为ID
                studentName: document.getElementById('studentName').value.trim(),
                studentId: document.getElementById('studentId').value.trim(),
                studentClass: document.getElementById('studentClass').value.trim(),
                politicalStatus: document.getElementById('politicalStatus').value.trim(),
                previousPosition: document.getElementById('previousPosition').value.trim(),
                currentPosition: document.getElementById('currentPosition').value.trim(),
                talkType: document.getElementById('talkType').value,
                talkDate: document.getElementById('talkDate').value,
                talkLocation: document.getElementById('talkLocation').value.trim(),
                riskLevel: document.getElementById('riskLevel').value,
                isResolved: isResolved,
                talkPurpose: document.getElementById('talkPurpose').value.trim(),
                talkContent: document.getElementById('talkContent').value.trim(),
                talkAssessment: document.getElementById('talkAssessment').value.trim(),
                followUpPlan: document.getElementById('followUpPlan').value.trim(),
                reflection: document.getElementById('reflection').value.trim(),
                createdAt: new Date().toISOString(),
                // 添加用户标识，确保数据隔离
                createdBy: currentUser.username
            };
            
            // 验证必填字段
            if (!record.studentName || !record.studentId || !record.studentClass || !record.talkDate) {
                alert('请填写姓名、学号、班级和谈话日期！');
                return;
            }
            
            // 添加到记录数组
            talkRecords.push(record);
            
            // 保存到本地存储
            saveRecords();
            
            alert('记录保存成功！');
            
            // 清空表单
            clearForm();
            
            // 切换到工作台
            switchPage('dashboard');
        }
        
        // 清空表单
        function clearForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentId').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('politicalStatus').value = '';
            document.getElementById('previousPosition').value = '';
            document.getElementById('currentPosition').value = '';
            document.getElementById('talkType').value = '常规关怀';
            document.getElementById('talkDate').valueAsDate = new Date();
            document.getElementById('talkLocation').value = '';
            document.getElementById('riskLevel').value = '低';
            document.getElementById('talkPurpose').value = '';
            document.getElementById('talkContent').value = '';
            document.getElementById('talkAssessment').value = '';
            document.getElementById('followUpPlan').value = '';
            document.getElementById('reflection').value = '';
            
            // 重置解决状态为已解决
            const statusOptions = document.querySelectorAll('.toggle-option');
            statusOptions.forEach(opt => {
                opt.classList.remove('active');
                opt.classList.remove('unresolved');
            });
            document.querySelector('.toggle-option[data-status="resolved"]').classList.add('active');
            isResolved = true;
        }
        
        // 显示所有记录
        function displayAllRecords(filteredRecords = null) {
            const recordsToShow = filteredRecords || talkRecords;
            const recordsList = document.getElementById('allRecordsList');
            
            if (recordsToShow.length === 0) {
                recordsList.innerHTML = `
                    <div class="no-records">
                        <i class="fas fa-comment-slash"></i>
                        <p>暂无谈话记录</p>
                    </div>
                `;
                return;
            }
            
            // 按日期倒序排列
            const sortedRecords = [...recordsToShow].sort((a, b) => new Date(b.talkDate) - new Date(a.talkDate));
            
            let html = '';
            sortedRecords.forEach(record => {
                // 获取风险等级对应的CSS类
                const riskClass = `tag-risk-${record.riskLevel === '高' ? 'high' : record.riskLevel === '中' ? 'medium' : 'low'}`;
                
                // 格式化谈话日期和时间
                const talkDate = new Date(record.talkDate);
                const formattedDate = talkDate.toLocaleDateString('zh-CN', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit' 
                });
                
                html += `
                <div class="record-item" data-id="${record.id}">
                    <div class="record-header">
                        <div class="student-info">
                            <div class="student-name">${record.studentName} <span class="student-id">(${record.studentId})</span></div>
                        </div>
                        <div class="talk-time">${formattedDate}</div>
                    </div>
                    <div class="record-tags">
                        <span class="tag tag-type">${record.talkType}</span>
                        <span class="tag tag-class">${record.studentClass}</span>
                        <span class="tag ${riskClass}">${record.riskLevel}风险</span>
                        ${!record.isResolved ? '<span class="tag tag-risk-high">待跟进</span>' : ''}
                    </div>
                    <div class="talk-purpose" title="${record.talkPurpose || '无描述'}">${record.talkPurpose ? (record.talkPurpose.length > 100 ? record.talkPurpose.substring(0, 100) + '...' : record.talkPurpose) : '无描述'}</div>
                    <div class="record-actions">
                        <button class="action-btn view-btn" onclick="viewRecord(${record.id})">
                            <i class="fas fa-eye"></i> 查看
                        </button>
                        <button class="action-btn edit-btn" onclick="editRecord(${record.id})">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteRecord(${record.id})">
                            <i class="fas fa-trash-alt"></i> 删除
                        </button>
                    </div>
                </div>
                `;
            });
            
            recordsList.innerHTML = html;
        }
        
        // 搜索记录
        function searchRecords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                displayAllRecords();
                return;
            }
            
            const filtered = talkRecords.filter(record => 
                record.studentName.toLowerCase().includes(searchTerm) ||
                record.studentId.toLowerCase().includes(searchTerm) ||
                record.studentClass.toLowerCase().includes(searchTerm) ||
                record.talkType.toLowerCase().includes(searchTerm) ||
                (record.talkPurpose && record.talkPurpose.toLowerCase().includes(searchTerm)) ||
                (record.talkContent && record.talkContent.toLowerCase().includes(searchTerm)) ||
                (record.talkAssessment && record.talkAssessment.toLowerCase().includes(searchTerm))
            );
            
            displayAllRecords(filtered);
        }
        
        // 查看记录详情
        function viewRecord(id) {
            const record = talkRecords.find(r => r.id === id);
            if (!record) {
                alert('记录不存在！');
                return;
            }
            
            // 获取风险等级对应的颜色类
            const riskColorClass = `risk-${record.riskLevel === '高' ? 'high' : record.riskLevel === '中' ? 'medium' : 'low'}`;
            
            // 格式化谈话日期
            const talkDate = new Date(record.talkDate);
            const formattedDate = talkDate.toLocaleDateString('zh-CN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit' 
            });
            
            const content = `
                <div style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px;">学生基本信息</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div><strong>姓名：</strong>${record.studentName}</div>
                        <div><strong>学号：</strong>${record.studentId}</div>
                        <div><strong>班级：</strong>${record.studentClass}</div>
                        <div><strong>政治面貌：</strong>${record.politicalStatus || '未填写'}</div>
                        <div><strong>曾任职务：</strong>${record.previousPosition || '未填写'}</div>
                        <div><strong>现任职务：</strong>${record.currentPosition || '未填写'}</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px;">谈话信息</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div><strong>谈话类型：</strong>${record.talkType}</div>
                        <div><strong>谈话日期：</strong>${formattedDate}</div>
                        <div><strong>谈话地点：</strong>${record.talkLocation || '未填写'}</div>
                        <div><strong>风险等级：</strong><span class="${riskColorClass}">${record.riskLevel}</span></div>
                        <div><strong>解决状态：</strong>${record.isResolved ? '<span style="color:#388e3c;">已解决</span>' : '<span style="color:#d32f2f;">未解决</span>'}</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div><strong>谈话背景与目的：</strong></div>
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin-top: 8px; min-height: 40px;">${record.talkPurpose || '未填写'}</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div><strong>谈话主要内容：</strong></div>
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin-top: 8px; min-height: 80px;">${record.talkContent || '未填写'}</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div><strong>关键发现与评估：</strong></div>
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin-top: 8px; min-height: 60px;">${record.talkAssessment || '未填写'}</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div><strong>后续跟进计划：</strong></div>
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin-top: 8px; min-height: 60px;">${record.followUpPlan || '未填写'}</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div><strong>辅导员反思：</strong></div>
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin-top: 8px; min-height: 60px;">${record.reflection || '未填写'}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('viewRecordContent').innerHTML = content;
            openModal('viewRecordModal');
        }
        
        // 编辑记录
        function editRecord(id) {
            const record = talkRecords.find(r => r.id === id);
            if (!record) {
                alert('记录不存在！');
                return;
            }
            
            currentEditingId = id;
            
            const content = `
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-user-graduate"></i> 学生基本信息
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editStudentName">姓名 *</label>
                            <input type="text" id="editStudentName" value="${record.studentName}">
                        </div>
                        <div class="form-group">
                            <label for="editStudentId">学号 *</label>
                            <input type="text" id="editStudentId" value="${record.studentId}">
                        </div>
                        <div class="form-group">
                            <label for="editStudentClass">班级 *</label>
                            <input type="text" id="editStudentClass" value="${record.studentClass}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editPoliticalStatus">政治面貌</label>
                            <select id="editPoliticalStatus">
                                <option value="">请选择</option>
                                <option value="中共党员" ${record.politicalStatus === '中共党员' ? 'selected' : ''}>中共党员</option>
                                <option value="中共预备党员" ${record.politicalStatus === '中共预备党员' ? 'selected' : ''}>中共预备党员</option>
                                <option value="共青团员" ${record.politicalStatus === '共青团员' ? 'selected' : ''}>共青团员</option>
                                <option value="群众" ${record.politicalStatus === '群众' ? 'selected' : ''}>群众</option>
                                <option value="其他" ${record.politicalStatus === '其他' ? 'selected' : ''}>其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editPreviousPosition">曾任职务</label>
                            <input type="text" id="editPreviousPosition" value="${record.previousPosition || ''}">
                        </div>
                        <div class="form-group">
                            <label for="editCurrentPosition">现任职务</label>
                            <input type="text" id="editCurrentPosition" value="${record.currentPosition || ''}">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-comment-dots"></i> 谈话信息
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editTalkType">谈话类型 *</label>
                            <select id="editTalkType">
                                <option value="常规关怀" ${record.talkType === '常规关怀' ? 'selected' : ''}>常规关怀</option>
                                <option value="学业问题" ${record.talkType === '学业问题' ? 'selected' : ''}>学业问题</option>
                                <option value="心理困扰" ${record.talkType === '心理困扰' ? 'selected' : ''}>心理困扰</option>
                                <option value="人际矛盾" ${record.talkType === '人际矛盾' ? 'selected' : ''}>人际矛盾</option>
                                <option value="职业规划" ${record.talkType === '职业规划' ? 'selected' : ''}>职业规划</option>
                                <option value="违纪沟通" ${record.talkType === '违纪沟通' ? 'selected' : ''}>违纪沟通</option>
                                <option value="其他" ${record.talkType === '其他' ? 'selected' : ''}>其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editTalkDate">谈话日期 *</label>
                            <input type="date" id="editTalkDate" value="${record.talkDate}">
                        </div>
                        <div class="form-group">
                            <label for="editTalkLocation">谈话地点</label>
                            <input type="text" id="editTalkLocation" value="${record.talkLocation || ''}">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editTalkPurpose">谈话背景与目的</label>
                        <textarea id="editTalkPurpose">${record.talkPurpose || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editTalkContent">谈话主要内容</label>
                        <textarea id="editTalkContent">${record.talkContent || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editTalkAssessment">关键发现与评估</label>
                        <textarea id="editTalkAssessment">${record.talkAssessment || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editFollowUpPlan">后续跟进计划</label>
                        <textarea id="editFollowUpPlan">${record.followUpPlan || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editReflection">辅导员反思</label>
                        <textarea id="editReflection">${record.reflection || ''}</textarea>
                    </div>
                    
                    <div class="form-row-2">
                        <div class="form-group">
                            <label for="editRiskLevel">风险等级</label>
                            <select id="editRiskLevel">
                                <option value="低" ${record.riskLevel === '低' ? 'selected' : ''}>低</option>
                                <option value="中" ${record.riskLevel === '中' ? 'selected' : ''}>中</option>
                                <option value="高" ${record.riskLevel === '高' ? 'selected' : ''}>高</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>解决状态</label>
                            <div class="status-toggle">
                                <div class="toggle-option ${record.isResolved ? 'active' : ''}" data-status="resolved" onclick="toggleEditStatus(this)">
                                    <i class="fas fa-check-circle"></i> 已解决
                                </div>
                                <div class="toggle-option ${!record.isResolved ? 'active' : ''}" data-status="unresolved" onclick="toggleEditStatus(this)">
                                    <i class="fas fa-exclamation-circle"></i> 未解决
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('editRecordContent').innerHTML = content;
            openModal('editRecordModal');
        }
        
        // 切换编辑状态
        function toggleEditStatus(element) {
            const toggleOptions = document.querySelectorAll('#editRecordContent .toggle-option');
            toggleOptions.forEach(opt => {
                opt.classList.remove('active');
                opt.classList.remove('unresolved');
            });
            element.classList.add('active');
            if (element.dataset.status === 'unresolved') {
                element.classList.add('unresolved');
            }
        }
        
        // 保存编辑后的记录
        function saveEditedRecord() {
            if (currentEditingId === null) return;
            
            const recordIndex = talkRecords.findIndex(r => r.id === currentEditingId);
            if (recordIndex === -1) {
                alert('记录不存在！');
                return;
            }
            
            // 获取编辑后的数据
            const isResolvedEdit = document.querySelector('#editRecordContent .toggle-option.active').dataset.status === 'resolved';
            
            talkRecords[recordIndex] = {
                ...talkRecords[recordIndex],
                studentName: document.getElementById('editStudentName').value.trim(),
                studentId: document.getElementById('editStudentId').value.trim(),
                studentClass: document.getElementById('editStudentClass').value.trim(),
                politicalStatus: document.getElementById('editPoliticalStatus').value.trim(),
                previousPosition: document.getElementById('editPreviousPosition').value.trim(),
                currentPosition: document.getElementById('editCurrentPosition').value.trim(),
                talkType: document.getElementById('editTalkType').value,
                talkDate: document.getElementById('editTalkDate').value,
                talkLocation: document.getElementById('editTalkLocation').value.trim(),
                riskLevel: document.getElementById('editRiskLevel').value,
                isResolved: isResolvedEdit,
                talkPurpose: document.getElementById('editTalkPurpose').value.trim(),
                talkContent: document.getElementById('editTalkContent').value.trim(),
                talkAssessment: document.getElementById('editTalkAssessment').value.trim(),
                followUpPlan: document.getElementById('editFollowUpPlan').value.trim(),
                reflection: document.getElementById('editReflection').value.trim()
            };
            
            // 验证必填字段
            if (!talkRecords[recordIndex].studentName || !talkRecords[recordIndex].studentId || 
                !talkRecords[recordIndex].studentClass || !talkRecords[recordIndex].talkDate) {
                alert('请填写姓名、学号、班级和谈话日期！');
                return;
            }
            
            // 保存到本地存储
            saveRecords();
            
            alert('记录更新成功！');
            closeModal('editRecordModal');
            displayAllRecords();
            updateDashboardStats();
        }
        
        // 删除记录
        function deleteRecord(id) {
            if (!confirm('确定要删除这条记录吗？此操作不可恢复。')) {
                return;
            }
            
            talkRecords = talkRecords.filter(record => record.id !== id);
            saveRecords();
            displayAllRecords();
            updateDashboardStats();
        }
        
        // 更新工作台统计数据
        function updateDashboardStats() {
            // 已记录学生数（去重）
            const uniqueStudents = [...new Set(talkRecords.map(record => record.studentId))];
            document.getElementById('totalStudents').textContent = uniqueStudents.length;
            
            // 谈心谈话总数
            document.getElementById('totalTalks').textContent = talkRecords.length;
            
            // 本月记录数
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthRecords = talkRecords.filter(record => {
                const recordDate = new Date(record.talkDate);
                return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
            });
            document.getElementById('monthTalks').textContent = monthRecords.length;
            
            // 待跟进记录数（未解决的记录）
            const pendingRecords = talkRecords.filter(record => !record.isResolved);
            document.getElementById('pendingTalks').textContent = pendingRecords.length;
            
            // 更新最近记录列表
            updateRecentRecords();
        }
        
        // 更新最近记录列表
        function updateRecentRecords() {
            const recentRecordsList = document.getElementById('recentRecordsList');
            
            if (talkRecords.length === 0) {
                recentRecordsList.innerHTML = `
                    <div class="no-records">
                        <i class="fas fa-comment-slash"></i>
                        <p>暂无谈话记录</p>
                    </div>
                `;
                return;
            }
            
            // 按日期倒序排列，取最近5条
            const sortedRecords = [...talkRecords].sort((a, b) => new Date(b.talkDate) - new Date(a.talkDate)).slice(0, 5);
            
            let html = '';
            sortedRecords.forEach(record => {
                // 获取风险等级对应的CSS类
                const riskClass = `tag-risk-${record.riskLevel === '高' ? 'high' : record.riskLevel === '中' ? 'medium' : 'low'}`;
                
                // 格式化谈话日期和时间
                const talkDate = new Date(record.talkDate);
                const formattedDate = talkDate.toLocaleDateString('zh-CN', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit' 
                });
                
                html += `
                <div class="record-item" onclick="viewRecord(${record.id})" style="cursor: pointer;">
                    <div class="record-header">
                        <div class="student-info">
                            <div class="student-name">${record.studentName} <span class="student-id">(${record.studentId})</span></div>
                        </div>
                        <div class="talk-time">${formattedDate}</div>
                    </div>
                    <div class="record-tags">
                        <span class="tag tag-type">${record.talkType}</span>
                        <span class="tag tag-class">${record.studentClass}</span>
                        <span class="tag ${riskClass}">${record.riskLevel}风险</span>
                        ${!record.isResolved ? '<span class="tag tag-risk-high">待跟进</span>' : ''}
                    </div>
                    <div class="talk-purpose" title="${record.talkPurpose || '无描述'}">${record.talkPurpose ? (record.talkPurpose.length > 100 ? record.talkPurpose.substring(0, 100) + '...' : record.talkPurpose) : '无描述'}</div>
                </div>
                `;
            });
            
            recentRecordsList.innerHTML = html;
        }
        
        // 按类型显示记录
        function showRecordsByType(type) {
            switchPage('allRecords');
            
            let filteredRecords = [];
            switch(type) {
                case 'all':
                    // 显示所有记录，无需过滤
                    return;
                case 'thisMonth':
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    filteredRecords = talkRecords.filter(record => {
                        const recordDate = new Date(record.talkDate);
                        return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
                    });
                    break;
                case 'pending':
                    filteredRecords = talkRecords.filter(record => !record.isResolved);
                    break;
            }
            
            displayAllRecords(filteredRecords);
        }
        
        // 导出为Excel
        function exportToExcel() {
            if (talkRecords.length === 0) {
                alert('没有数据可导出！');
                return;
            }
            
            // 准备数据
            const data = talkRecords.map(record => ({
                '姓名': record.studentName,
                '学号': record.studentId,
                '班级': record.studentClass,
                '政治面貌': record.politicalStatus || '',
                '曾任职务': record.previousPosition || '',
                '现任职务': record.currentPosition || '',
                '谈话类型': record.talkType,
                '谈话日期': record.talkDate,
                '谈话地点': record.talkLocation,
                '风险等级': record.riskLevel,
                '解决状态': record.isResolved ? '已解决' : '未解决',
                '谈话目的': record.talkPurpose,
                '谈话内容': record.talkContent,
                '关键发现': record.talkAssessment,
                '跟进计划': record.followUpPlan,
                '反思': record.reflection
            }));
            
            // 创建工作簿
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '谈心谈话记录');
            
            // 生成Excel文件并下载
            const fileName = `谈心谈话记录_${currentUser.username}_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        // 导出模板
        function exportTemplate() {
            const templateData = [{
                '姓名': '张三',
                '学号': '20210001',
                '班级': '2024级生物科学1班',
                '政治面貌': '共青团员',
                '曾任职务': '班长',
                '现任职务': '学习委员',
                '谈话类型': '学业问题',
                '谈话日期': '2023-10-15',
                '谈话地点': '至善楼208',
                '风险等级': '中',
                '解决状态': '未解决',
                '谈话目的': '学生近期成绩下滑严重，了解原因并提供帮助',
                '谈话内容': '学生表示近期沉迷游戏，导致学习时间不足...',
                '关键发现': '学生存在时间管理问题，缺乏学习计划',
                '跟进计划': '1. 每周检查学习计划；2. 安排学习小组互助',
                '反思': '需要更多关注学生的时间管理和学习习惯培养'
            }];
            
            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '导入模板');
            
            // 设置列宽
            const wscols = [
                {wch: 10}, // 姓名
                {wch: 12}, // 学号
                {wch: 18}, // 班级
                {wch: 12}, // 政治面貌
                {wch: 15}, // 曾任职务
                {wch: 15}, // 现任职务
                {wch: 12}, // 谈话类型
                {wch: 12}, // 谈话日期
                {wch: 15}, // 谈话地点
                {wch: 10}, // 风险等级
                {wch: 10}, // 解决状态
                {wch: 30}, // 谈话目的
                {wch: 40}, // 谈话内容
                {wch: 30}, // 关键发现
                {wch: 30}, // 跟进计划
                {wch: 30}  // 反思
            ];
            ws['!cols'] = wscols;
            
            XLSX.writeFile(wb, '谈心谈话记录导入模板.xlsx');
        }
        
        // 从Excel导入
        function importFromExcel(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        alert('Excel文件中没有数据！');
                        return;
                    }
                    
                    // 处理导入的数据
                    let importedCount = 0;
                    
                    jsonData.forEach(item => {
                        // 检查必填字段
                        if (!item['姓名'] || !item['学号'] || !item['班级'] || !item['谈话日期']) {
                            console.warn('跳过缺少必填字段的记录:', item);
                            return;
                        }
                        
                        // 创建新记录（总是新增，不覆盖）
                        const newRecord = {
                            id: Date.now() + Math.random(), // 生成新ID
                            studentName: String(item['姓名']),
                            studentId: String(item['学号']),
                            studentClass: String(item['班级']),
                            politicalStatus: item['政治面貌'] || '',
                            previousPosition: item['曾任职务'] || '',
                            currentPosition: item['现任职务'] || '',
                            talkType: item['谈话类型'] || '常规关怀',
                            talkDate: formatDate(item['谈话日期']),
                            talkLocation: item['谈话地点'] || '',
                            riskLevel: item['风险等级'] || '低',
                            isResolved: item['解决状态'] === '已解决' || item['解决状态'] === 'true' || item['解决状态'] === true,
                            talkPurpose: item['谈话目的'] || '',
                            talkContent: item['谈话内容'] || '',
                            talkAssessment: item['关键发现'] || '',
                            followUpPlan: item['跟进计划'] || '',
                            reflection: item['反思'] || '',
                            createdAt: new Date().toISOString(),
                            // 添加用户标识，确保数据隔离
                            createdBy: currentUser.username
                        };
                        
                        // 添加新记录
                        talkRecords.push(newRecord);
                        importedCount++;
                    });
                    
                    // 保存到本地存储
                    saveRecords();
                    
                    alert(`导入成功！新增 ${importedCount} 条记录。`);
                    displayAllRecords();
                    updateDashboardStats();
                    
                } catch (error) {
                    alert('导入失败：' + error.message);
                    console.error(error);
                }
                
                // 清空文件输入
                input.value = '';
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 格式化日期
        function formatDate(dateValue) {
            if (!dateValue) return new Date().toISOString().slice(0, 10);
            
            // 如果是日期对象
            if (dateValue instanceof Date) {
                return dateValue.toISOString().slice(0, 10);
            }
            
            // 如果是字符串
            const dateStr = String(dateValue);
            
            // 尝试解析Excel日期（可能是数字）
            if (!isNaN(dateStr) && dateStr.length > 5) {
                // Excel日期是从1900年1月1日开始的天数
                const excelDate = parseInt(dateStr);
                const date = new Date((excelDate - (25567 + 1)) * 86400 * 1000);
                return date.toISOString().slice(0, 10);
            }
            
            // 尝试解析YYYY-MM-DD格式
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return dateStr;
            }
            
            // 其他情况返回今天
            return new Date().toISOString().slice(0, 10);
        }
        
        // 显示清空数据弹窗
        function showClearDataModal() {
            document.getElementById('clearDataPassword').value = '';
            document.getElementById('clearDataError').style.display = 'none';
            openModal('clearDataModal');
        }
        
        // 确认清空数据
        function confirmClearData() {
            const password = document.getElementById('clearDataPassword').value;
            const errorElement = document.getElementById('clearDataError');
            
            // 验证密码
            const users = getUsers();
            const user = users.find(u => u.username === currentUser.username && u.password === password);
            
            if (!user) {
                errorElement.textContent = '密码错误！';
                errorElement.style.display = 'block';
                return;
            }
            
            talkRecords = [];
            saveRecords();
            displayAllRecords();
            updateDashboardStats();
            
            alert('所有数据已清空！');
            closeModal('clearDataModal');
        }
        
        // 打开弹窗
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        // 关闭弹窗
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            currentEditingId = null;
        }
    </script>
</body>
</html>